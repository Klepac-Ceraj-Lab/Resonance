# Redistributable analysis files for the RESONANCE prediction protocol

This folder contains scripts and accessory files to illustrate a minimal working example of the two main functionalities implemented by the Machine Learning section of this work:

1. Training a univariate Random Forest predictor (either a classifier or a regressor)
for a certain output variable from a set of features derived from a community profile;
2. Performing prediction on potentially unseen data using a pretrained predictor,
which can either be a readily-available redistributable model,
or one generated by the training protocol.

To reproduce this example, follow the instructions below.

## Setting up your computer

### Install Julia

1. Go to https://julialang.org/downloads/ to download the necessary files to run the Julia programming language in your computer.
This package is compatible with Julia version 1.8.
Linux users will probably want the compressed files containing the precompiled generic Linux binaries;
Windows users will benefit from the automated installer, but there is a precompiled version available for them as well.

2. After installing Julia, add the `$JULIA_FOLDER/bin/julia` executable to your `$PATH`.
You may test whether it worked by typing

```
$ julia
```

on a terminal. If successful, you will be greeted by the Julia REPL screen:

```
               _
   _       _ _(_)_     |  Documentation: https://docs.julialang.org
  (_)     | (_) (_)    |
   _ _   _| |_  __ _   |  Type "?" for help, "]?" for Pkg help.
  | | | | | | |/ _` |  |
  | | |_| | | | (_| |  |  Version 1.7.3 (2022-05-06)
 _/ |\__'_|_|_|\__'_|  |  Official https://julialang.org/ release
|__/                   |

julia>
```

Type `exit()` and <kbd>Enter</kbd> to exit the REPL.

### Download this repository

Download the latest release of this repository, and unpack it to the desired location. Eg

```bash
$ curl -LO https://github.com/Klepac-Ceraj-Lab/Resonance/archive/refs/tags/v0.3.0.tar.gz
#...

$ tar -xvzf v0.3.0.tar.gz
#...
```

Take note of the location of the unpacked directory
you will need to make this your working directory for future steps.

```bash
$ cd Resonance-v0.3.0
```


### (Optional) Pre-install the Dependencies

The example scripts are programmed to activate the project environment on startup, and automatically install the dependencies on the first run.
However, *if you wish to set up the dependencies separately*, while benefitting to the verbose logging of the package installer, follow the instructions:

1. Navigate to the folder where the cloned repository is.
2. Inside the folder, open up the Julia REPL with the command `julia --project=.`
   This will signal Julia to utilize the environment associated with the RESONANCE root folder, described by the `Project.toml`  and the `Manifest.toml` files included with the package.
3. on the Julia REPL, press the `]` key on the console.
The cursor will change to `(Resonance) pkg>`, which is called Package Mode
Double-check that the Package name (Resonance) is displayed within parentheses
If you see the Julia version (ex: `(@v1.7) pkg>`, `(@v1.8) pkg>`, etc.), you need to backtrack and make sure to start the process on the root of the package directory with the adequate arguments.
4. On Pkg mode, type `instantiate` and hit enter.
This command will install the compehensive list of dependencies on your `Project.toml` file.
5. Wait for precompilation and take note of any warnings, following the insctructions on screen to deal with them.
After precompilation, you will see the command line input again.
6. Test that the `Resonance` package can be loaded: hit `backspace` to go back to the julia REPL and type `using Resonance`.
If you do not get an error message withing a few seconds, you are ready to use the example scripts.

### (Optional) Download some of our pretrained models

If you have data that matches the format and acquisition constraints in the RESONANCE package publication, you may want to use our own models while predicting your own data.
In order to do so, you have to obtain the model binaries separately, since they are not included on this repository.
To obtain our models, follow the instructions:

1. Navigate to the Google Drive folder where the models are located: https://drive.google.com/drive/u/2/folders/1Av3TyvfiOIy5PbTMgsZiB6MRKNmzdWCw
2. If you cannot access the files, email [Kevin Bonhan](mailto:kbonham@wellesley.edu) or [Guilherme Bottino](mailto:gz101@wellesley.edu) regarding granting you access.
You may also use the "request access" functionality on Google Drive.
3. Download the models and extract them to the `models/` folder inside the package root directory.

## Running the example scripts

### Training your own models

The first example script is `examples/train_univariate_randomforest.jl`. This script takes five **mandatory** arguments:

```bash
$ julia examples/train_univariate_randomforest.jl {-c | -r} input_csv input_cols output_col output_filename
```

1. The first argument tells the script to run in either Regression or Classification mode.
2. The second argument is a community profile (with subjects/samples as rows, and features/predictors as columns) on the CSV format.
   The script expects a header for the CSV amd may fail if a header line is not provided.
   Please refer to the provided `examples/example_taxonomic_profile.csv` for formatting.
3. The third argument tells the script which columns contain the actual model inputs.
   This can be provided as a range (ex: `1:100`, `6:550`) or a column vector (ex: `[1,2,3,6,7,8,9,10,12]`).
   This is useful in case your model contains metadata columns that are irrelevant for prediction
4. The fourth argument tells the script which column contains the expected output for supervised training.
   Since this is a univariate predictor, this argument takes a single integer number.
5. The fifth argument is the path to the file that will store the trained model.
   We elected the `JLD2` Julia package to handle the distribution of models, hence the script expects the `.jld` file extension.

From the package root directory, you can use the example data provided to run the script. Try the commands

```
julia examples/train_univariate_randomforest.jl -c examples/example_taxonomic_profile.csv 6:554 4 examples/example_classifier_model.jld
julia examples/train_univariate_randomforest.jl -r examples/example_taxonomic_profile.csv 6:554 4 examples/example_regressor_model.jld
```

To train either a classifier or a regressor.

#### hyperparameter tuning

To keep execution times low, we ship the example script with a sparse grid for hyperparameter optimization.
As a consequence, the output models might have low predictive performance.
If the test run works, you may want to increase the density of the tuning grid, while also adjusting its boundaries.
In order to do so, edit the following lines on the training script:

```
tuning_space = (
    maxnodes_range = collect(1:3:15) ,
    nodesize_range = collect(1:3:20),
    sampsize_range = [0.6, 0.7],
    mtry_range = collect(5:10:100),
    ntrees_range = [300, 500, 700]
)
```

to match your desired configuration.
The names of each hyperparameter reflect the argument names in the preeminent `RandomForest` `R` package, for ease of use.

### Generating predictions using pretrained models

The second example script is `examples/predict_univariate_pretrained.jl`.
This script takes four **mandatory** arguments:

`julia examples/train_univariate_randomforest.jl model_jldpath input_csv input_cols output_filename`

1. The first argument is a path (either absolute or relative to the directory from where you are calling `julia`) to a pretrained `Resonance` univariate predictor (either a downloaded model, or one output by the example training script).

2. The second argument is a community profile (with subjects/samples as rows, and features/predictors as columns) on the CSV format.
The script expects a header for the CSV amd may fail if a header line is not provided. Please refer to the provided `examples/example_taxonomic_profile.csv` for formatting.

3. The third argument tells the script which columns contain the actual model inputs.
This can be provided as a range (ex: `1:100`, `6:550`) or a column vector (ex: `[1,2,3,6,7,8,9,10,12]`).
This is useful in case your model contains metadata columns that are irrelevant for prediction
   
4. The fourth argument is the path to the CSV file that will store the prediction outputs.
By default, If there are more columns on `input_csv` than those provided on `input_cols`, the output CSV file will contain those columns, with the prediction appended at the end.

From the package root directory, you can use the example data provided to run the script. Try the commands

```
julia examples/predict_univariate_pretrained.jl examples/example_classifier_model.jld examples/example_taxonomic_profile.csv 6:554 examples/classifier_output.csv
julia examples/predict_univariate_pretrained.jl examples/example_regressor_model.jld examples/example_taxonomic_profile.csv 6:554 examples/regressor_output.csv
```

## Citing this package

Resonance is work in Progress.
If you find it useful for your own efforts prior to publication, please cite this Github repository.
A soon as a publication is available, we will update this section.
